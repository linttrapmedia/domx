{
  "version": 3,
  "sources": ["../../../src/components/dx-state.ts"],
  "sourcesContent": ["type DxEvent = [dx: \"evt\", evt: string];\ntype DxAppend = [dx: \"append\", selector: string, html: string];\ntype DxAttr = [dx: \"attr\", selector: string, attr: string, value: string];\ntype DxClick = [dx: \"click\", selector: string, evt: string];\ntype DxCall = [\n  dx: \"call\",\n  selector: string,\n  method: string,\n  ...args: (string | number)[]\n];\ntype DxDispatch = [dx: \"dispatch\", evt: string, timeout?: number];\ntype DxGet = [dx: \"get\", url: string];\ntype DxWin = [dx: \"win\", method: string, ...args: (string | number)[]];\ntype DxPost = [\n  dx: \"post\",\n  url: string,\n  ...data: [\n    key: string,\n    selector: string,\n    val: \"value\" | \"dataset\" | \"formData\"\n  ][]\n];\ntype DxReplace = [dx: \"replace\", selector: string, content: string];\ntype DxServer = [dx: \"server\", key: string];\ntype DxState = [dx: \"state\", state: string];\ntype DxSubmit = [dx: \"submit\", selector: string, evt: string];\ntype DxText = [dx: \"text\", selector: string, text: string];\ntype DxWait = [dx: \"wait\", milliseconds: number, evt: string];\n\ntype DX =\n  | DxAppend\n  | DxAttr\n  | DxClick\n  | DxCall\n  | DxDispatch\n  | DxWin\n  | DxGet\n  | DxPost\n  | DxReplace\n  | DxServer\n  | DxState\n  | DxSubmit\n  | DxText\n  | DxWait;\n\ntype Config = {\n  actions: Record<string, DX[]>;\n  initialState: string;\n  listeners: [selector: string, event: string, evt: string][];\n  states: Record<string, Record<string | \"entry\", DX[]>>;\n};\n\nexport class DomxState extends HTMLElement {\n  state: string = \"\";\n  config: Config = {\n    actions: {},\n    initialState: \"\",\n    listeners: [],\n    states: {},\n  };\n  subs: ((state: string, evt: string, dx: DX) => void)[] = [];\n  timeouts: Record<string, NodeJS.Timeout> = {};\n  constructor() {\n    super();\n    this.handleEvent = this.handleEvent.bind(this);\n    this.applyAction = this.applyAction.bind(this);\n    this.applyAppend = this.applyAppend.bind(this);\n    this.applyAttr = this.applyAttr.bind(this);\n    this.applyCall = this.applyCall.bind(this);\n    this.applyEventListener = this.applyEventListener.bind(this);\n    this.applyDispatch = this.applyDispatch.bind(this);\n    this.applyGet = this.applyGet.bind(this);\n    this.applyWin = this.applyWin.bind(this);\n    this.applyPost = this.applyPost.bind(this);\n    this.applyReplace = this.applyReplace.bind(this);\n    this.applyState = this.applyState.bind(this);\n    this.applyText = this.applyText.bind(this);\n    this.applyWait = this.applyWait.bind(this);\n    this.dispatch = this.dispatch.bind(this);\n    this.handleClientEvent = this.handleClientEvent.bind(this);\n    this.handleServerEvent = this.handleServerEvent.bind(this);\n    this.init = this.init.bind(this);\n    this.sub = this.sub.bind(this);\n    this.transform = this.transform.bind(this);\n  }\n  applyAction(transformation: DxEvent) {\n    const [, action] = transformation;\n    this.config.actions[action].forEach((t) => this.handleEvent(action, [t]));\n  }\n  applyAppend(transformation: DxAppend) {\n    const [, selector, html] = transformation;\n    const el = this.querySelector(selector);\n    if (!el) return;\n    const tmpl = document.createElement(\"template\");\n    tmpl.innerHTML = decodeURIComponent(html);\n    el.append(tmpl.content);\n  }\n  applyAttr(transformation: DxAttr) {\n    const [, selector, attr, value] = transformation;\n    const els = this.querySelectorAll(selector) as NodeListOf<HTMLElement>;\n    els.forEach((el) => {\n      if (value === null) return el.removeAttribute(attr);\n      el.setAttribute(attr, value);\n    });\n  }\n  applyCall(transformation: DxCall) {\n    const [, selector, method, ...args] = transformation;\n    const el: any = this.querySelector(selector);\n    if (!el) return;\n    el[method](...args);\n  }\n  applyEventListener(transformation: DxClick) {\n    const [event, selector, evt] = transformation;\n    const els = this.querySelectorAll(selector) as NodeListOf<HTMLElement>;\n    for (let i = 0; i < els.length; i++) {\n      const el = els[i];\n      const cb = (e: any) => {\n        e.preventDefault();\n        this.handleClientEvent(evt);\n      };\n      el.removeEventListener(event, cb);\n      el.addEventListener(event, cb);\n    }\n  }\n  applyDispatch(transformation: DxDispatch) {\n    const [, evt, timeout = 0] = transformation;\n    clearTimeout(this.timeouts[evt]);\n    this.timeouts[evt] = setTimeout(() => this.handleClientEvent(evt), timeout);\n  }\n  applyGet(transformation: DxGet) {\n    const [, url] = transformation;\n    fetch(url, {\n      method: \"GET\",\n    }).then((r) => r.json().then((d) => this.handleEvent(\"entry\", d)));\n  }\n  applyWin(transformation: DxWin) {\n    const [, method, ...args] = transformation;\n    (<any>window)[method](...args);\n  }\n  applyPost(transformation: DxPost) {\n    const [, url, ...data] = transformation;\n    const body: any = {};\n    for (let i = 0; i < data.length; i++) {\n      const [key, selector, val] = data[i];\n      const el: any = this.querySelector(selector);\n      if (!el) return;\n      body[key] = el[val];\n    }\n    fetch(url, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(body),\n    }).then((r) => r.json().then((d) => this.handleEvent(\"entry\", d)));\n  }\n  applyReplace(transformation: DxReplace) {\n    const [, selector, content] = transformation;\n    const el = this.querySelector(selector);\n    if (!el) return;\n    const parent = el.parentElement;\n    if (!parent) return;\n    const tmpl = document.createElement(\"template\");\n    tmpl.innerHTML = decodeURIComponent(content);\n    parent.replaceChild(tmpl.content, el);\n  }\n  applyState(transformation: DxState) {\n    const [, state] = transformation;\n    const hasEntry = this.config.states[state].entry;\n    if (hasEntry) this.handleEvent(\"entry\", this.config.states[state].entry);\n    this.state = state;\n  }\n  applyText(transformation: DxText) {\n    const [, selector, text] = transformation;\n    const els = this.querySelectorAll(selector) as NodeListOf<HTMLElement>;\n    els.forEach((el) => (el.textContent = text));\n  }\n  applyWait(transformation: DxWait) {\n    const [, timeInSeconds, evt] = transformation;\n    const startTime = new Date().getTime();\n    while (new Date().getTime() - startTime < timeInSeconds) {\n      // Do nothing\n    }\n    if (evt) this.handleClientEvent(evt);\n  }\n  connectedCallback() {\n    const src = this.getAttribute(\"src\");\n    if (!src) return;\n    fetch(src).then((r) => r.json().then(this.init));\n  }\n  /**\n   * Dispatch an evt to the state machine manually\n   * @param evt name of evt to dispatch\n   */\n  dispatch(evt: string) {\n    this.handleClientEvent(evt);\n  }\n  /**\n   * Handle a client event\n   * @param evt name of evt to dispatch\n   */\n  handleClientEvent(evt: string) {\n    this.handleEvent(evt, this.config.states[this.state][evt] as DX[]);\n  }\n  /**\n   * Handle a server event\n   * @param se server event\n   */\n  handleServerEvent(se: { evt: string } & any) {\n    const { evt } = se;\n    const transformations = this.config.states[this.state][evt].reduce(\n      (acc, t) => [...acc, t],\n      [] as DX[]\n    );\n    this.handleEvent(evt, transformations);\n  }\n  /**\n   * Transform the state machine\n   * @param evt name of application to run\n   * @param transformations transformations to apply\n   */\n  handleEvent(evt: string, transformations: DX[]) {\n    if (!transformations) return;\n    for (let i = 0; i < transformations.length; i++) {\n      const transformation = transformations[i];\n      const [trait] = transformation;\n      const traitMap = {\n        action: this.applyAction,\n        append: this.applyAppend,\n        attr: this.applyAttr,\n        call: this.applyCall,\n        click: this.applyEventListener,\n        dispatch: this.applyDispatch,\n        get: this.applyGet,\n        post: this.applyPost,\n        replace: this.applyReplace,\n        state: this.applyState,\n        submit: this.applyEventListener,\n        text: this.applyText,\n        wait: this.applyWait,\n        win: this.applyWin,\n      };\n      (traitMap as any)[trait](transformation);\n      this.subs.forEach((s) => s(this.state, evt, transformation));\n    }\n  }\n  init(config: Config) {\n    this.config = config;\n    const that = this;\n\n    // Apply listeners\n    const listeners = this.config.listeners ?? [];\n\n    const register = () => {\n      for (let i = 0; i < listeners.length; i++) {\n        const [selector, event, evt] = listeners[i];\n        const els = this.querySelectorAll(selector) as NodeListOf<HTMLElement>;\n        for (let j = 0; j < els.length; j++) {\n          const el = els[j];\n          const cb = (e: any) => {\n            e.preventDefault();\n            if (e.target !== el) return;\n            this.handleClientEvent(evt);\n          };\n          that.removeEventListener(event, cb);\n          that.addEventListener(event, cb);\n        }\n      }\n    };\n\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.type === \"childList\" && mutation.addedNodes) register();\n      });\n    });\n\n    observer.observe(this, {\n      attributes: true,\n      childList: true,\n      subtree: true,\n    });\n\n    register();\n\n    // Apply initial state\n    const initState = config.states[config.initialState];\n    this.state = config.initialState;\n    if (initState.entry) this.handleEvent(\"entry\", initState.entry);\n  }\n  sub(s: (state: string, evt: string, dx: DX) => void) {\n    this.subs.push(s);\n  }\n  transform(evt: string, transformations: DX[]) {\n    this.handleEvent(evt, transformations);\n  }\n}\n\ncustomElements.define(\"dx-state\", DomxState);\n"],
  "mappings": "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",
  "names": ["DomxState", "transformation", "action", "t", "selector", "html", "el", "tmpl", "attr", "value", "method", "args", "event", "evt", "els", "i", "cb", "e", "timeout", "url", "r", "d", "data", "body", "key", "val", "content", "parent", "state", "text", "timeInSeconds", "startTime", "src", "se", "transformations", "acc", "trait", "s", "config", "that", "listeners", "register", "j", "mutations", "mutation", "initState"]
}
