<html>
    <head>
      <title>DOMX Unit Tests</title>
      <script>"use strict";var DOMX=(()=>{async function*I(n){for(let t of n)yield new Promise(e=>{t(s=>{e(s)})})}async function G(n){let t=[];for await(let e of I(n))t.push(e);return t}async function E(n){return await G(n).then(t=>{let e=document.querySelector("#test-sandbox"),s=document.querySelector("#test-results");s.style.display="grid",s.style.columnGap="10px",s.style.rowGap="2px",s.style.gridTemplateColumns="auto auto 1fr",t.forEach(r=>{let o=document.createElement("div");o.style.fontFamily="monospace",o.style.fontSize="14px",o.style.color=r.pass?"green":"red",o.innerText=r.pass?"\u2714":"\u2718",o.className=r.pass?"pass":"fail";let a=document.createElement("div");a.innerText=r.label+": ",a.style.color=r.pass?"green":"red";let i=document.createElement("div");i.innerText=r.message||"",i.style.color=r.pass?"green":"red",s.append(o,a,i),e.innerHTML=""}),s.dataset.status="done"})}function f(n){if(n.startsWith("#")){let t=document.querySelector(n);return t?[t]:document.querySelectorAll(n)}else return document.querySelectorAll(n)}async function W(n,t,e){f(t).forEach(r=>r.classList.add(e))}async function N(n,t,e,s){n.removeEventListenersForSelector(t,e);let r=o=>{o.preventDefault(),n.dispatch(s)};n.addEventListenerToElement(t,e,r)}async function U(n,t,e){let s=document.querySelector(t);if(!s)return;let r=document.createElement("template");r.innerHTML=decodeURIComponent(e),s.append(r.content)}async function B(n,...t){console.log(...t)}async function O(n,t,e=0){clearTimeout(n.timeouts[t]),n.timeouts[t]=setTimeout(()=>n.dispatch(t),e)}async function j(n,t,...e){window.history[t](...e)}async function K(n,t,e){(()=>{let r=new URLSearchParams;e.forEach(([a,i,l,d])=>{switch(l){case"attribute":let u=document.querySelector(i);if(!u)return;r.append(a,u.getAttribute(d));break;case"dataset":let T=document.querySelector(i);if(!T)return;r.append(a,T.dataset[l][d]);break;case"value":let h=document.querySelector(i);if(!h)return;r.append(a,h.value);break}});let o=t+"?"+r.toString();fetch(o,{method:"GET",headers:{domx:n.getHeaderData()}}).then(a=>a.json().then(i=>n.transform(i)))})()}async function J(n,t,e){let s=document.querySelector(t);!s||(s.innerHTML=decodeURIComponent(e))}async function V(n,t){window.location.href=t}async function z(n,t,e){(()=>{let r=new FormData;e.forEach(([o,a,i,l])=>{switch(i){case"attribute":let d=document.querySelector(a);if(!d)return;r.append(o,d.getAttribute(l));break;case"dataset":let u=document.querySelector(a);if(!u)return;r.append(o,u.dataset[i][l]);break;case"value":let T=document.querySelector(a);if(!T)return;r.append(o,T.value);break}}),fetch(t,{body:r,method:"POST",headers:{domx:n.getHeaderData()}}).then(o=>o.json().then(a=>n.transform(a)))})()}async function Q(n,t,e){f(t).forEach(r=>r.removeAttribute(e))}async function X(n,t){let e=document.querySelector(t);!e||e.remove()}async function Y(n,t,e){n.removeEventListenersForSelector(t,e)}async function Z(n,t,e){f(t).forEach(r=>r.classList.remove(e))}async function tt(n,t,e){let s=document.querySelector(t);if(!s)return;let r=document.createRange().createContextualFragment(e);s.replaceWith(r)}async function et(n,t,e,s){f(t).forEach(o=>{if(s===null)return o.removeAttribute(e);o.setAttribute(e,s)})}async function st(n,t){n.fsm.states[t].exit&&n.dispatch("exit"),n.state=t,n.fsm.states[t].entry&&n.dispatch("entry")}async function nt(n,t){let e=document.querySelector(t),s=(e.method??"POST").toUpperCase(),r=e.enctype??"application/x-www-form-urlencoded",o=new FormData(e);fetch(e.action,{body:o,method:s,headers:{domx:n.getHeaderData(),contentType:r}}).then(a=>a.json().then(i=>n.transform(i)))}async function rt(n,t,e){let s=document.querySelector(t);!s||(s.textContent=decodeURIComponent(e))}async function ot(n,t,e){let s=document.querySelector(t);!s||s.dispatchEvent(new Event(e))}async function at(n,t){return n.debouncing=!0,new Promise(e=>setTimeout(e,t)).then(()=>n.debouncing=!1)}async function it(n,t,...e){window[t](...e)}var c=class{eventRegistry=[];debouncing=!1;fsm={id:"",initialState:"",listeners:[],states:{}};state="";subs=[];timeouts={};tranformers={};constructor(t){this.addEventListenerToElement=this.addEventListenerToElement.bind(this),this.dispatch=this.dispatch.bind(this),this.init=this.init.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.removeEventListenersForSelector=this.removeEventListenersForSelector.bind(this),this.registerEventListeners=this.registerEventListeners.bind(this),this.sub=this.sub.bind(this),this.transform=this.transform.bind(this),this.addTransformer("addClass",W),this.addTransformer("addEventListener",N),this.addTransformer("append",U),this.addTransformer("console",B),this.addTransformer("dispatch",O),this.addTransformer("innerHTML",J),this.addTransformer("history",j),this.addTransformer("get",K),this.addTransformer("location",V),this.addTransformer("post",z),this.addTransformer("remove",X),this.addTransformer("removeAttribute",Q),this.addTransformer("removeClass",Z),this.addTransformer("removeEventListener",Y),this.addTransformer("replace",tt),this.addTransformer("setAttribute",et),this.addTransformer("state",st),this.addTransformer("submit",nt),this.addTransformer("textContent",rt),this.addTransformer("trigger",ot),this.addTransformer("wait",at),this.addTransformer("window",it),t&&this.init(t)}addEventListenerToElement(t,e,s){this.eventRegistry.push({selector:t,event:e,handler:s}),document.addEventListener(e,r=>{let o=r.target;o&&o.matches(t)&&s(r)})}addTransformer(t,e){return this.tranformers[t]=e,this}dispatch(t){let e=this.fsm.states[this.state][t];if(!e)return;let s=this.state;this.transform(e,()=>{this.subs.forEach(r=>r(t,s,this.state))})}getHeaderData(){return JSON.stringify({id:this.fsm.id,state:this.state})}init(t){this.fsm=t,this.registerEventListeners();let e=t.states[t.initialState];this.state=t.initialState,e.entry&&this.dispatch("entry")}removeEventListenersForSelector(t,e){this.eventRegistry.filter(r=>r.selector===t&&r.event===e).forEach(r=>{document.removeEventListener(r.event,r.handler)}),this.eventRegistry=this.eventRegistry.filter(r=>!(r.selector===t&&r.event===e))}removeAllEventListeners(){this.eventRegistry.forEach(t=>{document.removeEventListener(t.event,t.handler)}),this.eventRegistry=[]}registerEventListeners(){let t=this.fsm.listeners??[];for(let e=0;e<t.length;e++){let[s,r,o]=t[e],a=f(s);for(let i=0;i<a.length;i++){let l=a[i],d=u=>{u.preventDefault(),u.target===l&&this.dispatch(o)};this.removeEventListenersForSelector(s,r),this.addEventListenerToElement(s,r,d)}}}sub(t){return this.subs.push(t),()=>this.unsub(t)}async transform(t=[],e){if(!!t&&!this.debouncing){for(let s=0;s<t.length;s++){let r=t[s],[o,...a]=r,i=this.tranformers[o];if(!i)throw new Error(`Unknown transformer: ${o}`);await i(this,...a)}e&&e()}}unsub=t=>{this.subs=this.subs.filter(e=>e!==t)}},g=class extends HTMLElement{instance=new c;constructor(){super(),this.registerLocalFSM=this.registerLocalFSM.bind(this),this.registerRemoteFSM=this.registerRemoteFSM.bind(this);let t=document.createElement("slot");t.style.display="none",this.attachShadow({mode:"open"}).appendChild(t),t.addEventListener("slotchange",()=>this.registerLocalFSM(t))}connectedCallback(){this.getAttribute("src")&&this.registerRemoteFSM()}registerLocalFSM(t){let s=t.assignedNodes()[0].nodeValue;if(s)return this.instance.init(JSON.parse(s))}registerRemoteFSM(){let t=this.getAttribute("src");if(t)return fetch(t).then(e=>e.json().then(this.instance.init))}};customElements.define("dom-x",g);window.Domx=c;var m=()=>`el${Math.random().toString(36).substring(7)}`,v=n=>{let t=!1;function e(){t=!0}let s=m(),r=new c({id:"fsm",initialState:"TEST",states:{TEST:{submit:[["submit",`#${s}`]]}}});r.addTransformer("submit",e),r.dispatch("submit"),r.sub((o,a,i)=>{o==="submit"&&t&&n({label:"Submit",pass:!0,message:"can submit form"})})},y=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["append",`#${e}`,"<span>test</span>"]]}}}).dispatch("test");let r=t.querySelector(`#${e}`)?.outerHTML===`<div id="${e}"><span>test</span></div>`;n({label:"Append",pass:r,message:"can append element"})},S=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["setAttribute",`#${e}`,"data-test","test"]]}}}).dispatch("test");let r=document.getElementById(e)?.outerHTML===`<div id="${e}" data-test="test"></div>`;n({label:"Attr",pass:r,message:"can set attribute"})},b=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("button");s.id=e,t.appendChild(s);let r=new c({id:"fsm",initialState:"TEST",listeners:[[`#${e}`,"click","t1"]],states:{TEST:{t1:[["state","CLICKED"]]},CLICKED:{}}});s.click(),r.sub((o,a,i)=>{i==="CLICKED"&&n({label:"AddEventListener",pass:!0,message:"can add event listener"})})},x=n=>{new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["dispatch","test"]],test:[["state","DISPATCHED"]]},DISPATCHED:{}}}).sub((e,s,r)=>{r==="DISPATCHED"&&n({label:"Dispatch",pass:!0,message:"can dispatch event"})})},L=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("input");s.id=e,s.value="test",t.appendChild(s);let r="";async function o(i,l,d){r=t.querySelector(d[0][1]).value??"",i.transform([["state","TESTED"]])}let a=new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["get","/test",[["data",`#${e}`,"value"]]]]},TESTED:{}}});a.addTransformer("get",o),a.dispatch("test"),a.sub((i,l,d)=>{d==="TESTED"&&r==="test"&&n({label:"Get",pass:!0,message:"can fetch a url"})})},w=n=>{window.history.pushState=function(t,e){t==="TEST"&&e==="/test"&&n({label:"History",pass:!0,message:"can set history"})},new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["history","pushState","TEST","/test"]]}}})},A=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("input");s.id=e,s.value="test",t.appendChild(s);let r="";async function o(i,l,d){r=t.querySelector(d[0][1]).value??"",i.transform([["state","TESTED"]])}let a=new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["post","/test",[["data",`#${e}`,"value"]]]]},TESTED:{}}});a.addTransformer("post",o),a.dispatch("test"),a.sub((i,l,d)=>{d==="TESTED"&&r==="test"&&n({label:"Post",pass:!0,message:"can post a form"})})},D=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("div");s.id=e,s.setAttribute("data-test","test"),t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["removeAttribute",`#${e}`,"data-test"]]}}}).dispatch("test");let r=document.getElementById(e)?.outerHTML===`<div id="${e}"></div>`;n({label:"RemoveAttribute",pass:r,message:"can remove attribute"})},R=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("div");s.id=e,s.classList.add("test"),t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["removeClass",`#${e}`,"test"],["dispatch","test"]],test:[]}}}).sub(o=>{o==="test"&&!s.classList.contains("test")&&n({label:"RemoveClass",pass:!0,message:"can remove class"})})},C=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("button");s.id=e,t.appendChild(s);let r=new c({id:"fsm",initialState:"TEST",listeners:[[`#${e}`,"click","t1"]],states:{TEST:{entry:[["removeEventListener",`#${e}`,"click"],["trigger",`#${e}`,"click"]],t1:[["state","UNREACHABLE"]]},UNREACHABLE:{}}});r.sub(()=>{r.eventRegistry.length===0&&n({label:"RemoveEventListener",pass:!0,message:"can remove event listener"})})},q=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("div");s.innerHTML=`<span id="replace-${e}">replace me</span>`,s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["replace",`#replace-${e}`,`<span id="replaced-${e}">test</span>`],["state","REPLACED"]]},REPLACED:{}}}).sub((o,a,i)=>{i==="REPLACED"&&t.querySelector(`#replaced-${e}`)?.outerHTML&&n({label:"Replace",pass:!0,message:"can replace element"})})},M=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["setAttribute",`#${e}`,"data-test","test"]]}}}).dispatch("test");let r=document.getElementById(e)?.outerHTML===`<div id="${e}" data-test="test"></div>`;n({label:"SetAttribute",pass:r,message:"can set attribute"})},H=n=>setTimeout(()=>n({label:"Smoke",pass:!0,message:"test suite is working"}),0),k=n=>{new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["state","TESTED"]]},TESTED:{}}}).sub((e,s,r)=>{r==="TESTED"&&n({label:"State",pass:!0,message:"can change state"})})},F=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("div");s.id=e,s.textContent="test",t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["textContent",`#${e}`,"tested"]]}}}).dispatch("test");let r=document.getElementById(e)?.outerHTML===`<div id="${e}">tested</div>`;n({label:"TextContent",pass:r,message:"can set textContent"})},$=n=>{let t=Date.now();new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["wait",100],["state","TESTED"]]},TESTED:{}}}).sub((s,r,o)=>{o==="TESTED"&&Date.now()-t>100&&n({label:"Wait",pass:!0,message:"can wait"})})},P=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("button");s.id=e,t.appendChild(s);let r=Date.now(),o=0;function a(){o++}let i=new c({id:"fsm",initialState:"TEST",listeners:[[`#${e}`,"click","test"]],states:{TEST:{test:[["wait",100],["count"]]},TESTED:{}}});i.addTransformer("count",a),s.click(),s.click(),s.click(),i.sub((l,d,u)=>{o===1&&Date.now()-r>100&&n({label:"WaitAsDebouncer",pass:!0,message:"wait can debounce events"})})},_=n=>{let t=document.querySelector("#test-sandbox"),e=m(),s=document.createElement("div");s.id=e,t.appendChild(s);let r=!1;window.alert=a=>{a==="test"&&(r=!0)},new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["window","alert","test"]]}}}).sub((a,i,l)=>{r&&n({label:"WindowMethods",pass:!0,message:"can call window methods"})})};window.addEventListener("DOMContentLoaded",async()=>{await E([H,v,y,S,b,x,L,w,A,D,R,C,q,M,k,F,_,$,P])});})();
</script>
    </head>
    <body>
      <div id="test-results" data-status="processing"></div>
      <div id="test-sandbox"></div>
    </body>
  </html>