<html>
    <head>
      <title>DOMX Unit Tests</title>
      <script>"use strict";var DOMX=(()=>{async function*k(r){for(let t of r)yield new Promise(e=>{t(s=>{e(s)})})}async function $(r){let t=[];for await(let e of k(r))t.push(e);return t}async function y(r){return await $(r).then(t=>{let e=document.querySelector("#test-sandbox"),s=document.querySelector("#test-results");s.style.display="grid",s.style.columnGap="10px",s.style.rowGap="2px",s.style.gridTemplateColumns="auto auto 1fr",t.forEach(n=>{let o=document.createElement("div");o.style.fontFamily="monospace",o.style.fontSize="14px",o.style.color=n.pass?"green":"red",o.innerText=n.pass?"\u2714":"\u2718",o.className=n.pass?"pass":"fail";let i=document.createElement("div");i.innerText=n.label+": ",i.style.color=n.pass?"green":"red";let a=document.createElement("div");a.innerText=n.message||"",a.style.color=n.pass?"green":"red",s.append(o,i,a),e.innerHTML=""}),s.dataset.status="done"})}function f(r){if(r.startsWith("#")){let t=document.querySelector(r);return t?[t]:document.querySelectorAll(r)}else return document.querySelectorAll(r)}async function P(r,t,e){f(t).forEach(n=>n.classList.add(e))}async function _(r,t,e,s){r.removeEventListenersForSelector(t,e);let n=o=>{o.preventDefault(),r.dispatch(s)};r.addEventListenerToElement(t,e,n)}async function G(r,t,e){let s=document.querySelector(t);if(!s)return;let n=document.createElement("template");n.innerHTML=decodeURIComponent(e),s.append(n.content)}async function I(r,...t){console.log(...t)}async function N(r,t,e=0){clearTimeout(r.timeouts[t]),r.timeouts[t]=setTimeout(()=>r.dispatch(t),e)}async function U(r,t,...e){window.history[t](...e)}async function O(r,t,e){(()=>{let n=new URLSearchParams;e.forEach(([i,a,m,d])=>{switch(m){case"attribute":let u=document.querySelector(a);if(!u)return;n.append(i,u.getAttribute(d));break;case"dataset":let T=document.querySelector(a);if(!T)return;n.append(i,T.dataset[m][d]);break;case"value":let h=document.querySelector(a);if(!h)return;n.append(i,h.value);break}});let o=t+"?"+n.toString();fetch(o,{method:"GET",headers:{domx:r.getHeaderData()}}).then(i=>i.json().then(a=>r.transform(a)))})()}async function B(r,t,e){let s=document.querySelector(t);!s||(s.innerHTML=decodeURIComponent(e))}async function j(r,t){window.location.href=t}async function K(r,t,e){(()=>{let n=new FormData;e.forEach(([o,i,a,m])=>{switch(a){case"attribute":let d=document.querySelector(i);if(!d)return;n.append(o,d.getAttribute(m));break;case"dataset":let u=document.querySelector(i);if(!u)return;n.append(o,u.dataset[a][m]);break;case"value":let T=document.querySelector(i);if(!T)return;n.append(o,T.value);break}}),fetch(t,{body:n,method:"POST",headers:{domx:r.getHeaderData()}}).then(o=>o.json().then(i=>r.transform(i)))})()}async function J(r,t,e){f(t).forEach(n=>n.removeAttribute(e))}async function V(r,t){let e=document.querySelector(t);!e||e.remove()}async function W(r,t,e){r.removeEventListenersForSelector(t,e)}async function z(r,t,e){f(t).forEach(n=>n.classList.remove(e))}async function Q(r,t,e){let s=document.querySelector(t);if(!s)return;let n=document.createRange().createContextualFragment(e);s.replaceWith(n)}async function X(r,t,e,s){f(t).forEach(o=>{if(s===null)return o.removeAttribute(e);o.setAttribute(e,s)})}async function Y(r,t){r.fsm.states[t].exit&&r.dispatch("exit"),r.state=t,r.fsm.states[t].entry&&r.dispatch("entry")}async function Z(r,t){let e=document.querySelector(t),s=(e.method??"POST").toUpperCase(),n=e.enctype??"application/x-www-form-urlencoded",o=new FormData(e);fetch(e.action,{body:o,method:s,headers:{domx:r.getHeaderData(),contentType:n}}).then(i=>i.json().then(a=>r.transform(a)))}async function tt(r,t,e){let s=document.querySelector(t);!s||(s.textContent=decodeURIComponent(e))}async function et(r,t,e){let s=document.querySelector(t);!s||s.dispatchEvent(new Event(e))}async function st(r,t){return new Promise(e=>setTimeout(e,t))}async function nt(r,t,...e){window[t](...e)}var c=class{eventRegistry=[];fsm={id:"",initialState:"",listeners:[],states:{}};state="";subs=[];timeouts={};tranformers={};constructor(t){this.addEventListenerToElement=this.addEventListenerToElement.bind(this),this.dispatch=this.dispatch.bind(this),this.init=this.init.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.removeEventListenersForSelector=this.removeEventListenersForSelector.bind(this),this.registerEventListeners=this.registerEventListeners.bind(this),this.sub=this.sub.bind(this),this.transform=this.transform.bind(this),this.addTransformer("addClass",P),this.addTransformer("addEventListener",_),this.addTransformer("append",G),this.addTransformer("console",I),this.addTransformer("dispatch",N),this.addTransformer("innerHTML",B),this.addTransformer("history",U),this.addTransformer("get",O),this.addTransformer("location",j),this.addTransformer("post",K),this.addTransformer("remove",V),this.addTransformer("removeAttribute",J),this.addTransformer("removeClass",z),this.addTransformer("removeEventListener",W),this.addTransformer("replace",Q),this.addTransformer("setAttribute",X),this.addTransformer("state",Y),this.addTransformer("submit",Z),this.addTransformer("textContent",tt),this.addTransformer("trigger",et),this.addTransformer("wait",st),this.addTransformer("window",nt),t&&this.init(t)}addEventListenerToElement(t,e,s){this.eventRegistry.push({selector:t,event:e,handler:s}),document.addEventListener(e,n=>{let o=n.target;o&&o.matches(t)&&s(n)})}addTransformer(t,e){return this.tranformers[t]=e,this}dispatch(t){let e=this.fsm.states[this.state][t];if(!e)return;let s=this.state;this.transform(e,()=>{this.subs.forEach(n=>n(t,s,this.state))})}getHeaderData(){return JSON.stringify({id:this.fsm.id,state:this.state})}init(t){this.fsm=t,this.registerEventListeners();let e=t.states[t.initialState];this.state=t.initialState,e.entry&&this.dispatch("entry")}removeEventListenersForSelector(t,e){this.eventRegistry.filter(n=>n.selector===t&&n.event===e).forEach(n=>{document.removeEventListener(n.event,n.handler)}),this.eventRegistry=this.eventRegistry.filter(n=>!(n.selector===t&&n.event===e))}removeAllEventListeners(){this.eventRegistry.forEach(t=>{document.removeEventListener(t.event,t.handler)}),this.eventRegistry=[]}registerEventListeners(){let t=this.fsm.listeners??[];for(let e=0;e<t.length;e++){let[s,n,o]=t[e],i=f(s);for(let a=0;a<i.length;a++){let m=i[a],d=u=>{u.preventDefault(),u.target===m&&this.dispatch(o)};this.removeEventListenersForSelector(s,n),this.addEventListenerToElement(s,n,d)}}}sub(t){return this.subs.push(t),()=>this.unsub(t)}async transform(t=[],e){if(!!t){for(let s=0;s<t.length;s++){let n=t[s],[o,...i]=n,a=this.tranformers[o];if(!a)throw new Error(`Unknown transformer: ${o}`);await a(this,...i)}e&&e()}}unsub=t=>{this.subs=this.subs.filter(e=>e!==t)}},g=class extends HTMLElement{instance=new c;constructor(){super(),this.registerLocalFSM=this.registerLocalFSM.bind(this),this.registerRemoteFSM=this.registerRemoteFSM.bind(this);let t=document.createElement("slot");t.style.display="none",this.attachShadow({mode:"open"}).appendChild(t),t.addEventListener("slotchange",()=>this.registerLocalFSM(t))}connectedCallback(){this.getAttribute("src")&&this.registerRemoteFSM()}registerLocalFSM(t){let s=t.assignedNodes()[0].nodeValue;if(s)return this.instance.init(JSON.parse(s))}registerRemoteFSM(){let t=this.getAttribute("src");if(t)return fetch(t).then(e=>e.json().then(this.instance.init))}};customElements.define("dom-x",g);window.Domx=c;var l=()=>`el${Math.random().toString(36).substring(7)}`,E=r=>{let t=!1;function e(){t=!0}let s=l(),n=new c({id:"fsm",initialState:"TEST",states:{TEST:{submit:[["submit",`#${s}`]]}}});n.addTransformer("submit",e),n.dispatch("submit"),n.sub((o,i,a)=>{o==="submit"&&t&&r({label:"Submit",pass:!0,message:"can submit form"})})},v=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["append",`#${e}`,"<span>test</span>"]]}}}).dispatch("test");let n=t.querySelector(`#${e}`)?.outerHTML===`<div id="${e}"><span>test</span></div>`;r({label:"Append",pass:n,message:"can append element"})},S=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["setAttribute",`#${e}`,"data-test","test"]]}}}).dispatch("test");let n=document.getElementById(e)?.outerHTML===`<div id="${e}" data-test="test"></div>`;r({label:"Attr",pass:n,message:"can set attribute"})},b=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("button");s.id=e,t.appendChild(s);let n=new c({id:"fsm",initialState:"TEST",listeners:[[`#${e}`,"click","t1"]],states:{TEST:{t1:[["state","CLICKED"]]},CLICKED:{}}});s.click(),n.sub((o,i,a)=>{a==="CLICKED"&&r({label:"AddEventListener",pass:!0,message:"can add event listener"})})},x=r=>{new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["dispatch","test"]],test:[["state","DISPATCHED"]]},DISPATCHED:{}}}).sub((e,s,n)=>{n==="DISPATCHED"&&r({label:"Dispatch",pass:!0,message:"can dispatch event"})})},L=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("input");s.id=e,s.value="test",t.appendChild(s);let n="";async function o(a,m,d){n=t.querySelector(d[0][1]).value??"",a.transform([["state","TESTED"]])}let i=new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["get","/test",[["data",`#${e}`,"value"]]]]},TESTED:{}}});i.addTransformer("get",o),i.dispatch("test"),i.sub((a,m,d)=>{console.log(a,m,d,n),d==="TESTED"&&n==="test"&&r({label:"Get",pass:!0,message:"can fetch a url"})})},A=r=>{window.history.pushState=function(t,e){t==="TEST"&&e==="/test"&&r({label:"History",pass:!0,message:"can set history"})},new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["history","pushState","TEST","/test"]]}}})},R=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("input");s.id=e,s.value="test",t.appendChild(s);let n="";async function o(a,m,d){n=t.querySelector(d[0][1]).value??"",a.transform([["state","TESTED"]])}let i=new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["post","/test",[["data",`#${e}`,"value"]]]]},TESTED:{}}});i.addTransformer("post",o),i.dispatch("test"),i.sub((a,m,d)=>{console.log(a,m,d,n),d==="TESTED"&&n==="test"&&r({label:"Post",pass:!0,message:"can post a form"})})},w=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,s.setAttribute("data-test","test"),t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["removeAttribute",`#${e}`,"data-test"]]}}}).dispatch("test");let n=document.getElementById(e)?.outerHTML===`<div id="${e}"></div>`;r({label:"RemoveAttribute",pass:n,message:"can remove attribute"})},D=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,s.classList.add("test"),t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["removeClass",`#${e}`,"test"],["dispatch","test"]],test:[]}}}).sub(o=>{o==="test"&&!s.classList.contains("test")&&r({label:"RemoveClass",pass:!0,message:"can remove class"})})},q=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("button");s.id=e,t.appendChild(s);let n=new c({id:"fsm",initialState:"TEST",listeners:[[`#${e}`,"click","t1"]],states:{TEST:{entry:[["removeEventListener",`#${e}`,"click"],["trigger",`#${e}`,"click"]],t1:[["state","UNREACHABLE"]]},UNREACHABLE:{}}});n.sub(()=>{n.eventRegistry.length===0&&r({label:"RemoveEventListener",pass:!0,message:"can remove event listener"})})},C=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.innerHTML=`<span id="replace-${e}">replace me</span>`,s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["replace",`#replace-${e}`,`<span id="replaced-${e}">test</span>`],["state","REPLACED"]]},REPLACED:{}}}).sub((o,i,a)=>{a==="REPLACED"&&t.querySelector(`#replaced-${e}`)?.outerHTML&&r({label:"Replace",pass:!0,message:"can replace element"})})},M=r=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["setAttribute",`#${e}`,"data-test","test"]]}}}).dispatch("test");let n=document.getElementById(e)?.outerHTML===`<div id="${e}" data-test="test"></div>`;r({label:"SetAttribute",pass:n,message:"can set attribute"})},H=r=>setTimeout(()=>r({label:"Smoke",pass:!0,message:"test suite is working"}),0),F=r=>{new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["state","TESTED"]]},TESTED:{}}}).sub((e,s,n)=>{n==="TESTED"&&r({label:"State",pass:!0,message:"can change state"})})};window.addEventListener("DOMContentLoaded",async()=>{await y([H,E,v,S,b,x,L,A,R,w,D,q,C,M,F])});})();
</script>
    </head>
    <body>
      <div id="test-results" data-status="processing"></div>
      <div id="test-sandbox"></div>
    </body>
  </html>