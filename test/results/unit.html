<html>
    <head>
      <title>DOMX Unit Tests</title>
      <script>"use strict";var DOMX=(()=>{async function*w(s){for(let e of s)yield new Promise(t=>{e.done(r=>{t(r)})})}async function D(s){let e=[];for await(let t of w(s))e.push(t);return e}async function x(s){return await D(s).then(e=>{let t=document.querySelector("#test-sandbox"),r=document.querySelector("#test-results");r.style.display="grid",r.style.columnGap="10px",r.style.rowGap="2px",r.style.gridTemplateColumns="auto auto 1fr",e.forEach(n=>{let i=document.createElement("div");i.style.fontFamily="monospace",i.style.fontSize="14px",i.style.color=n.pass?"green":"red",i.innerText=n.pass?"\u2714":"\u2718",i.className=n.pass?"pass":"fail";let o=document.createElement("div");o.innerText=n.label+": ",o.style.color=n.pass?"green":"red";let a=document.createElement("div");a.innerText=n.message||"",a.style.color=n.pass?"green":"red",r.append(i,o,a),t.innerHTML=""}),r.dataset.status="done"})}function g(s,e=300){let t;return function(...r){clearTimeout(t),t=setTimeout(()=>{s.apply(this,r)},e)}}function f(s){if(s.startsWith("#")){let e=document.querySelector(s);return e?[e]:document.querySelectorAll(s)}else return document.querySelectorAll(s)}async function C(s,e,t){f(e).forEach(n=>n.classList.add(t))}async function R(s,e,t,r,n){f(e).forEach(o=>{let a=c=>{c.preventDefault(),c.target===o&&s.dispatch(r)};n?.debounce?(o.removeEventListener(t,g(a,n?.debounce)),o.addEventListener(t,g(a,n?.debounce))):(o.removeEventListener(t,a),o.addEventListener(t,a))})}async function M(s,e,t){let r=document.querySelector(e);if(!r)return;let n=document.createElement("template");n.innerHTML=decodeURIComponent(t),r.append(n.content)}async function q(s,...e){console.log(...e)}async function H(s,e,t=0){clearTimeout(s.timeouts[e]),s.timeouts[e]=setTimeout(()=>s.dispatch(e),t)}async function F(s,e,t,r){window.history.pushState(e,t,r)}async function k(s,e,t,r){let n=()=>{let o=new URLSearchParams;t.forEach(([c,d,m,l])=>{switch(m){case"attribute":let p=document.querySelector(d);if(!p)return;o.append(c,p.getAttribute(l));break;case"dataset":let T=document.querySelector(d);if(!T)return;o.append(c,T.dataset[m][l]);break;case"value":let v=document.querySelector(d);if(!v)return;o.append(c,v.value);break}});let a=e+"?"+o.toString();fetch(a,{method:"GET",headers:{domx:s.getHeaderData()}}).then(c=>c.json().then(d=>s.transform(d)))},i=g(n,r?.debounce);r?.debounce?i():n()}async function _(s,e,t){let r=document.querySelector(e);!r||(r.innerHTML=decodeURIComponent(t))}async function I(s,e){window.location.href=e}async function N(s,e,t,r){let n=()=>{let o=new FormData;t.forEach(([a,c,d,m])=>{switch(d){case"attribute":let l=document.querySelector(c);if(!l)return;o.append(a,l.getAttribute(m));break;case"dataset":let p=document.querySelector(c);if(!p)return;o.append(a,p.dataset[d][m]);break;case"value":let T=document.querySelector(c);if(!T)return;o.append(a,T.value);break}}),fetch(e,{body:o,method:"POST",headers:{domx:s.getHeaderData()}}).then(a=>a.json().then(c=>s.transform(c)))},i=g(n,r?.debounce);r?.debounce?i():n()}async function $(s,e,t){f(e).forEach(n=>n.removeAttribute(t))}async function P(s,e){let t=document.querySelector(e);!t||t.remove()}async function G(s,e,t,r){f(e).forEach(i=>{let o=a=>{a.preventDefault(),a.target===i&&s.dispatch(r)};i.removeEventListener(t,o)})}async function U(s,e,t){f(e).forEach(n=>n.classList.remove(t))}async function K(s,e,t){let r=document.querySelector(e);if(!r)return;let n=document.createElement("template");n.innerHTML=decodeURIComponent(t),r.replaceWith(n.content)}async function O(s,e,t,r){f(e).forEach(i=>{if(r===null)return i.removeAttribute(t);i.setAttribute(t,r)})}async function j(s,e){s.fsm.states[e].exit&&s.dispatch("exit"),s.state=e,s.fsm.states[e].entry&&s.dispatch("entry")}async function J(s,e){let t=document.querySelector(e),r=(t.method??"POST").toUpperCase(),n=t.enctype??"application/x-www-form-urlencoded",i=new FormData(t);fetch(t.action,{body:i,method:r,headers:{domx:s.getHeaderData(),contentType:n}}).then(o=>o.json().then(a=>s.transform(a)))}async function B(s,e,t){let r=document.querySelector(e);!r||(r.textContent=decodeURIComponent(t))}async function W(s,e,t){let r=document.querySelector(e);!r||r.dispatchEvent(new Event(t))}async function z(s,e){return new Promise(t=>setTimeout(t,e))}async function V(s,e,...t){window[e](...t)}var u=class{fsm={id:"",initialState:"",listeners:[],states:{}};state="";subs=[];timeouts={};tranformers={};addTransformer(e,t){return this.tranformers[e]=t,this}constructor(e){this.dispatch=this.dispatch.bind(this),this.init=this.init.bind(this),this.registerEventListeners=this.registerEventListeners.bind(this),this.sub=this.sub.bind(this),this.transform=this.transform.bind(this),this.addTransformer("addClass",C),this.addTransformer("addEventListener",R),this.addTransformer("append",M),this.addTransformer("console",q),this.addTransformer("dispatch",H),this.addTransformer("innerHTML",_),this.addTransformer("history",F),this.addTransformer("get",k),this.addTransformer("location",I),this.addTransformer("post",N),this.addTransformer("remove",P),this.addTransformer("removeAttribute",$),this.addTransformer("removeClass",U),this.addTransformer("removeEventListener",G),this.addTransformer("replace",K),this.addTransformer("setAttribute",O),this.addTransformer("state",j),this.addTransformer("submit",J),this.addTransformer("textContent",B),this.addTransformer("trigger",W),this.addTransformer("wait",z),this.addTransformer("window",V),e&&this.init(e)}dispatch(e){let t=this.fsm.states[this.state][e];if(!t)return;let r=this.state;this.transform(t,()=>{this.subs.forEach(n=>n(e,r,this.state))})}getHeaderData(){return JSON.stringify({id:this.fsm.id,state:this.state})}init(e){this.fsm=e,this.registerEventListeners();let t=e.states[e.initialState];this.state=e.initialState,t.entry&&this.dispatch("entry")}registerEventListeners(){let e=this.fsm.listeners??[];for(let t=0;t<e.length;t++){let[r,n,i]=e[t],o=f(r);for(let a=0;a<o.length;a++){let c=o[a],d=m=>{m.preventDefault(),m.target===c&&this.dispatch(i)};c.removeEventListener(n,d),c.addEventListener(n,d)}}}sub(e){return this.subs.push(e),()=>this.unsub(e)}async transform(e=[],t){if(!!e){for(let r=0;r<e.length;r++){let n=e[r],[i,...o]=n,a=this.tranformers[i];if(!a)throw new Error(`Unknown transformer: ${i}`);await a(this,...o)}t&&t()}}unsub=e=>{this.subs=this.subs.filter(t=>t!==e)}},b=class extends HTMLElement{instance=new u;constructor(){super(),this.registerLocalFSM=this.registerLocalFSM.bind(this),this.registerRemoteFSM=this.registerRemoteFSM.bind(this);let e=document.createElement("slot");e.style.display="none",this.attachShadow({mode:"open"}).appendChild(e),e.addEventListener("slotchange",()=>this.registerLocalFSM(e))}connectedCallback(){this.getAttribute("src")&&this.registerRemoteFSM()}registerLocalFSM(e){let r=e.assignedNodes()[0].nodeValue;if(r)return this.instance.init(JSON.parse(r))}registerRemoteFSM(){let e=this.getAttribute("src");if(e)return fetch(e).then(t=>t.json().then(this.instance.init))}};customElements.define("dom-x",b);window.Domx=u;var h=()=>`el${Math.random().toString(36).substring(7)}`,E={done:s=>setTimeout(()=>s({label:"Smoke",pass:!0,message:"test suite is working"}),0)},S={done:s=>{let e=document.querySelector("#test-sandbox"),t=h(),r=document.createElement("div");r.id=t,e.appendChild(r),new u({id:"fsm",initialState:"TEST",states:{TEST:{test:[["append",`#${t}`,"<span>test</span>"]]}}}).dispatch("test");let n=e.querySelector(`#${t}`)?.outerHTML===`<div id="${t}"><span>test</span></div>`;s({label:"Append",pass:n,message:"can append element"})}},L={done:s=>{let e=document.querySelector("#test-sandbox"),t=h(),r=document.createElement("div");r.id=t,e.appendChild(r),new u({id:"fsm",initialState:"TEST",states:{TEST:{test:[["setAttribute",`#${t}`,"data-test","test"]]}}}).dispatch("test");let n=document.getElementById(t)?.outerHTML===`<div id="${t}" data-test="test"></div>`;s({label:"Attr",pass:n,message:"can set attribute"})}},A={done:s=>{let e=document.querySelector("#test-sandbox"),t=h(),r=document.createElement("button");r.id=t,e.appendChild(r);let n=h(),i=new u({id:"fsm",initialState:"TEST",listeners:[[`#${t}`,"click","t1"]],states:{TEST:{t1:[["state","CLICKED"]]},CLICKED:{entry:[["append","#test-sandbox",`<button id="${n}">dynamically added</button>`],["addEventListener",`#${n}`,"click","t2"],["trigger",`#${n}`,"click"]],t2:[["state","CLICKED_AGAIN"]]},CLICKED_AGAIN:{}}});r?.click(),i.sub((o,a,c)=>{c==="CLICKED_AGAIN"&&s({label:"AddEventListener",pass:!0,message:"can add event listener"})})}};window.addEventListener("DOMContentLoaded",async()=>{await x([E,S,L,A])});})();
</script>
    </head>
    <body>
      <div id="test-results" data-status="processing"></div>
      <div id="test-sandbox"></div>
    </body>
  </html>