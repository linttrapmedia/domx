<html>
    <head>
      <title>DOMX Unit Tests</title>
      <script>"use strict";var DOMX=(()=>{async function*G(n){for(let t of n)yield new Promise(e=>{t(s=>{e(s)})})}async function W(n){let t=[];for await(let e of G(n))t.push(e);return t}async function E(n){return await W(n).then(t=>{let e=document.querySelector("#test-sandbox"),s=document.querySelector("#test-results");s.style.display="grid",s.style.columnGap="10px",s.style.rowGap="2px",s.style.gridTemplateColumns="auto auto 1fr",t.forEach(r=>{let o=document.createElement("div");o.style.fontFamily="monospace",o.style.fontSize="14px",o.style.color=r.pass?"green":"red",o.innerText=r.pass?"\u2714":"\u2718",o.className=r.pass?"pass":"fail";let a=document.createElement("div");a.innerText=r.label+": ",a.style.color=r.pass?"green":"red";let i=document.createElement("div");i.innerText=r.message||"",i.style.color=r.pass?"green":"red",s.append(o,a,i),e.innerHTML=""}),s.dataset.status="done"})}function p(n){if(n.startsWith("#")){let t=document.querySelector(n);return t?[t]:document.querySelectorAll(n)}else return document.querySelectorAll(n)}function v(n,t){let e;return(...s)=>{clearTimeout(e),e=setTimeout(()=>n(...s),t)}}async function N(n,t,e){p(t).forEach(r=>r.classList.add(e))}async function U(n,t,e,s,r=0){n.removeEventListenersForSelector(t,e);let a=v(i=>{i.preventDefault(),n.dispatch(s)},r);n.addEventListenerToElement(t,e,a)}async function B(n,t,e){let s=document.querySelector(t);if(!s)return;let r=document.createElement("template");r.innerHTML=decodeURIComponent(e),s.append(r.content)}async function O(n,...t){console.log(...t)}async function j(n,t,e=0){clearTimeout(n.timeouts[t]),n.timeouts[t]=setTimeout(()=>n.dispatch(t),e)}async function K(n,t,...e){window.history[t](...e)}async function J(n,t,e){(()=>{let r=new URLSearchParams;e.forEach(([a,i,m,d])=>{switch(m){case"attribute":let u=document.querySelector(i);if(!u)return;r.append(a,u.getAttribute(d));break;case"dataset":let T=document.querySelector(i);if(!T)return;r.append(a,T.dataset[m][d]);break;case"value":let f=document.querySelector(i);if(!f)return;r.append(a,f.value);break}});let o=t+"?"+r.toString();fetch(o,{method:"GET",headers:{domx:n.getHeaderData()}}).then(a=>a.json().then(i=>n.transform(i)))})()}async function V(n,t,e){let s=document.querySelector(t);!s||(s.innerHTML=decodeURIComponent(e))}async function z(n,t){window.location.href=t}async function Q(n,t,e){(()=>{let r=new FormData;e.forEach(([o,a,i,m])=>{switch(i){case"attribute":let d=document.querySelector(a);if(!d)return;r.append(o,d.getAttribute(m));break;case"dataset":let u=document.querySelector(a);if(!u)return;r.append(o,u.dataset[i][m]);break;case"value":let T=document.querySelector(a);if(!T)return;r.append(o,T.value);break}}),fetch(t,{body:r,method:"POST",headers:{domx:n.getHeaderData()}}).then(o=>o.json().then(a=>n.transform(a)))})()}async function X(n,t,e){p(t).forEach(r=>r.removeAttribute(e))}async function Y(n,t){let e=document.querySelector(t);!e||e.remove()}async function Z(n,t,e){n.removeEventListenersForSelector(t,e)}async function tt(n,t,e){p(t).forEach(r=>r.classList.remove(e))}async function et(n,t,e){let s=document.querySelector(t);if(!s)return;let r=document.createRange().createContextualFragment(e);s.replaceWith(r)}async function st(n,t,e,s){p(t).forEach(o=>{if(s===null)return o.removeAttribute(e);o.setAttribute(e,s)})}async function nt(n,t){n.fsm.states[t].exit&&n.dispatch("exit"),n.state=t,n.fsm.states[t].entry&&n.dispatch("entry")}async function rt(n,t){let e=document.querySelector(t),s=(e.method??"POST").toUpperCase(),r=e.enctype??"application/x-www-form-urlencoded",o=new FormData(e);fetch(e.action,{body:o,method:s,headers:{domx:n.getHeaderData(),contentType:r}}).then(a=>a.json().then(i=>n.transform(i)))}async function ot(n,t,e){let s=document.querySelector(t);!s||(s.textContent=decodeURIComponent(e))}async function at(n,t,e){let s=document.querySelector(t);!s||s.dispatchEvent(new Event(e))}async function it(n,t){return new Promise(e=>setTimeout(e,t))}async function ct(n,t,...e){window[t](...e)}var c=class{eventRegistry=[];debouncing={};fsm={id:"",initialState:"",listeners:[],states:{}};state="";subs=[];timeouts={};tranformers={};constructor(t){this.addEventListenerToElement=this.addEventListenerToElement.bind(this),this.dispatch=this.dispatch.bind(this),this.init=this.init.bind(this),this.removeAllEventListeners=this.removeAllEventListeners.bind(this),this.removeEventListenersForSelector=this.removeEventListenersForSelector.bind(this),this.registerEventListeners=this.registerEventListeners.bind(this),this.sub=this.sub.bind(this),this.transform=this.transform.bind(this),this.addTransformer("addClass",N),this.addTransformer("addEventListener",U),this.addTransformer("append",B),this.addTransformer("console",O),this.addTransformer("dispatch",j),this.addTransformer("innerHTML",V),this.addTransformer("history",K),this.addTransformer("get",J),this.addTransformer("location",z),this.addTransformer("post",Q),this.addTransformer("remove",Y),this.addTransformer("removeAttribute",X),this.addTransformer("removeClass",tt),this.addTransformer("removeEventListener",Z),this.addTransformer("replace",et),this.addTransformer("setAttribute",st),this.addTransformer("state",nt),this.addTransformer("submit",rt),this.addTransformer("textContent",ot),this.addTransformer("trigger",at),this.addTransformer("wait",it),this.addTransformer("window",ct),t&&this.init(t)}addEventListenerToElement(t,e,s){this.eventRegistry.push({selector:t,event:e,handler:s}),document.addEventListener(e,r=>{let o=r.target;o&&o.matches(t)&&s(r)})}addTransformer(t,e){return this.tranformers[t]=e,this}dispatch(t){let e=this.fsm.states[this.state][t];if(!e||this.debouncing[t])return;let s=this.state;this.transform(e,()=>{this.subs.forEach(r=>r(t,s,this.state))})}getHeaderData(){return JSON.stringify({id:this.fsm.id,state:this.state})}init(t){this.fsm=t,this.registerEventListeners();let e=t.states[t.initialState];this.state=t.initialState,e.entry&&this.dispatch("entry")}removeEventListenersForSelector(t,e){this.eventRegistry.filter(r=>r.selector===t&&r.event===e).forEach(r=>{document.removeEventListener(r.event,r.handler)}),this.eventRegistry=this.eventRegistry.filter(r=>!(r.selector===t&&r.event===e))}removeAllEventListeners(){this.eventRegistry.forEach(t=>{document.removeEventListener(t.event,t.handler)}),this.eventRegistry=[]}registerEventListeners(){let t=this.fsm.listeners??[];for(let e=0;e<t.length;e++){let[s,r,o,a=0]=t[e],i=p(s);for(let m=0;m<i.length;m++){let d=i[m],T=v(f=>{f.preventDefault(),f.target===d&&this.dispatch(o)},a);this.removeEventListenersForSelector(s,r),this.addEventListenerToElement(s,r,T)}}}sub(t){return this.subs.push(t),()=>this.unsub(t)}async transform(t=[],e){if(!!t){for(let s=0;s<t.length;s++){let r=t[s],[o,...a]=r,i=this.tranformers[o];if(!i)throw new Error(`Unknown transformer: ${o}`);await i(this,...a)}e&&e()}}unsub=t=>{this.subs=this.subs.filter(e=>e!==t)}},g=class extends HTMLElement{instance=new c;constructor(){super(),this.registerLocalFSM=this.registerLocalFSM.bind(this),this.registerRemoteFSM=this.registerRemoteFSM.bind(this);let t=document.createElement("slot");t.style.display="none",this.attachShadow({mode:"open"}).appendChild(t),t.addEventListener("slotchange",()=>this.registerLocalFSM(t))}connectedCallback(){this.getAttribute("src")&&this.registerRemoteFSM()}registerLocalFSM(t){let s=t.assignedNodes()[0].nodeValue;if(s)return this.instance.init(JSON.parse(s))}registerRemoteFSM(){let t=this.getAttribute("src");if(t)return fetch(t).then(e=>e.json().then(this.instance.init))}};customElements.define("dom-x",g);window.Domx=c;var l=()=>`el${Math.random().toString(36).substring(7)}`,y=n=>{let t=!1;function e(){t=!0}let s=l(),r=new c({id:"fsm",initialState:"TEST",states:{TEST:{submit:[["submit",`#${s}`]]}}});r.addTransformer("submit",e),r.dispatch("submit"),r.sub((o,a,i)=>{o==="submit"&&t&&n({label:"Submit",pass:!0,message:"can submit form"})})},S=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["append",`#${e}`,"<span>test</span>"]]}}}).dispatch("test");let r=t.querySelector(`#${e}`)?.outerHTML===`<div id="${e}"><span>test</span></div>`;n({label:"Append",pass:r,message:"can append element"})},b=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["setAttribute",`#${e}`,"data-test","test"]]}}}).dispatch("test");let r=document.getElementById(e)?.outerHTML===`<div id="${e}" data-test="test"></div>`;n({label:"Attr",pass:r,message:"can set attribute"})},x=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("button");s.id=e,t.appendChild(s);let r=new c({id:"fsm",initialState:"TEST",listeners:[[`#${e}`,"click","t1"]],states:{TEST:{t1:[["state","CLICKED"]]},CLICKED:{}}});s.click(),r.sub((o,a,i)=>{i==="CLICKED"&&n({label:"AddEventListener",pass:!0,message:"can add event listener"})})},L=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("button");s.id=e,t.appendChild(s);let r=0;function o(){console.log("eventCounterTransformer"),r++}let a=new c({id:"fsm",initialState:"TEST",listeners:[[`#${e}`,"click","test",200]],states:{TEST:{test:[["count"]]},TESTED:{}}});a.addTransformer("count",o);let i=Date.now();for(s.click(),s.click(),s.click();Date.now()-i<50;);for(s.click(),s.click(),s.click();Date.now()-i<50;);for(s.click();Date.now()-i<50;);for(s.click();Date.now()-i<50;);s.click(),a.sub((m,d,u)=>{r===1&&Date.now()-i>250&&n({label:"WaitAsDebouncer",pass:!0,message:"wait can debounce events"})})},w=n=>{new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["dispatch","test"]],test:[["state","DISPATCHED"]]},DISPATCHED:{}}}).sub((e,s,r)=>{r==="DISPATCHED"&&n({label:"Dispatch",pass:!0,message:"can dispatch event"})})},A=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("input");s.id=e,s.value="test",t.appendChild(s);let r="";async function o(i,m,d){r=t.querySelector(d[0][1]).value??"",i.transform([["state","TESTED"]])}let a=new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["get","/test",[["data",`#${e}`,"value"]]]]},TESTED:{}}});a.addTransformer("get",o),a.dispatch("test"),a.sub((i,m,d)=>{d==="TESTED"&&r==="test"&&n({label:"Get",pass:!0,message:"can fetch a url"})})},D=n=>{window.history.pushState=function(t,e){t==="TEST"&&e==="/test"&&n({label:"History",pass:!0,message:"can set history"})},new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["history","pushState","TEST","/test"]]}}})},R=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("input");s.id=e,s.value="test",t.appendChild(s);let r="";async function o(i,m,d){r=t.querySelector(d[0][1]).value??"",i.transform([["state","TESTED"]])}let a=new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["post","/test",[["data",`#${e}`,"value"]]]]},TESTED:{}}});a.addTransformer("post",o),a.dispatch("test"),a.sub((i,m,d)=>{d==="TESTED"&&r==="test"&&n({label:"Post",pass:!0,message:"can post a form"})})},C=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,s.setAttribute("data-test","test"),t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["removeAttribute",`#${e}`,"data-test"]]}}}).dispatch("test");let r=document.getElementById(e)?.outerHTML===`<div id="${e}"></div>`;n({label:"RemoveAttribute",pass:r,message:"can remove attribute"})},q=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,s.classList.add("test"),t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["removeClass",`#${e}`,"test"],["dispatch","test"]],test:[]}}}).sub(o=>{o==="test"&&!s.classList.contains("test")&&n({label:"RemoveClass",pass:!0,message:"can remove class"})})},M=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("button");s.id=e,t.appendChild(s);let r=new c({id:"fsm",initialState:"TEST",listeners:[[`#${e}`,"click","t1"]],states:{TEST:{entry:[["removeEventListener",`#${e}`,"click"],["trigger",`#${e}`,"click"]],t1:[["state","UNREACHABLE"]]},UNREACHABLE:{}}});r.sub(()=>{r.eventRegistry.length===0&&n({label:"RemoveEventListener",pass:!0,message:"can remove event listener"})})},H=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.innerHTML=`<span id="replace-${e}">replace me</span>`,s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["replace",`#replace-${e}`,`<span id="replaced-${e}">test</span>`],["state","REPLACED"]]},REPLACED:{}}}).sub((o,a,i)=>{i==="REPLACED"&&t.querySelector(`#replaced-${e}`)?.outerHTML&&n({label:"Replace",pass:!0,message:"can replace element"})})},k=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["setAttribute",`#${e}`,"data-test","test"]]}}}).dispatch("test");let r=document.getElementById(e)?.outerHTML===`<div id="${e}" data-test="test"></div>`;n({label:"SetAttribute",pass:r,message:"can set attribute"})},F=n=>setTimeout(()=>n({label:"Smoke",pass:!0,message:"test suite is working"}),0),$=n=>{new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["state","TESTED"]]},TESTED:{}}}).sub((e,s,r)=>{r==="TESTED"&&n({label:"State",pass:!0,message:"can change state"})})},P=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,s.textContent="test",t.appendChild(s),new c({id:"fsm",initialState:"TEST",states:{TEST:{test:[["textContent",`#${e}`,"tested"]]}}}).dispatch("test");let r=document.getElementById(e)?.outerHTML===`<div id="${e}">tested</div>`;n({label:"TextContent",pass:r,message:"can set textContent"})},_=n=>{let t=Date.now();new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["wait",100],["state","TESTED"]]},TESTED:{}}}).sub((s,r,o)=>{o==="TESTED"&&Date.now()-t>100&&n({label:"Wait",pass:!0,message:"can wait"})})},I=n=>{let t=document.querySelector("#test-sandbox"),e=l(),s=document.createElement("div");s.id=e,t.appendChild(s);let r=!1;window.alert=a=>{a==="test"&&(r=!0)},new c({id:"fsm",initialState:"TEST",states:{TEST:{entry:[["window","alert","test"]]}}}).sub((a,i,m)=>{r&&n({label:"WindowMethods",pass:!0,message:"can call window methods"})})};window.addEventListener("DOMContentLoaded",async()=>{await E([F,y,S,b,x,L,w,A,D,R,C,q,M,H,k,$,P,I,_])});})();
</script>
    </head>
    <body>
      <div id="test-results" data-status="processing"></div>
      <div id="test-sandbox"></div>
    </body>
  </html>